<!DOCTYPE html>
<html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <!-- Downloaded from: https://github.com/RobotWebTools/roslibjs/blob/develop/build/roslib.js -->
  <script type="text/javascript" src="src/roslib.js"></script>

  <script src="xeogl/build/xeogl.js"></script>
  <script src="xeogl/examples/js/geometry/vectorTextGeometry.js"></script>
  <script src="xeogl/examples/js/models/STLModel.js"></script>
  <script src="xeogl/examples/js/animation/cameraFollowAnimation.js"></script>
  <script src="xeogl/examples/js/skyboxes/skybox.js"></script>

  <script src="src/Chart.js-2.9.3/dist/Chart.js"></script>

  <script src="src/divTabs.js"></script>

<!-- Downloaded from: https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js -->
<script src='src/mapbox/mapbox-gl.js'></script>
<!-- Downloaded from: https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css -->
<link href='src/mapbox-gl.css' rel='stylesheet' />

  <!-- Creating Global Variables -->
  <script type="text/javascript">
    var scene;
    var skybox;
    var BoatModel;
    var camera;
    var followAnimation;

    const zeroAxisButton = 9; // The start button on the Logitech Gamepad F310
    const leftJoystickVert = 1; // The index of the left joystick's vertical axis
    const rightJoystickVert = 4; // The index of the left joystick's vertical axis
    var axisOffset = [0, 0, 0, 0];
    var gpPollInt = 100;
    var gpidx;

    var orientation_deg = [0, 0, 0]
    var IMU_Cnt = 0;
    var IMU_Accel_Cnt = 0;

    var map;
    var marker;
    var GPS_latitude = 0;
    var GPS_longitude = 0;
    var GPS_altitude = 0;
    var GPS_fix = 0;
    var GPS_fixquality = 0;

    var MAX_PLOT_IDX = 100;

    var bat_6s;
    var bat_4s;
    var bat_3sa;
    var bat_3sb;
  </script>

  <!-- Styles -->
  <style>
    #canvas-holder {
      background-color: #FFFFFF;
      position: relative;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
    }

    * {
      box-sizing: border-box;
    }

    #map {
      height: 30vw;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
    }

    /* Style the header */
    .header {
      background-color: #f1f1f1;
      padding: 5vw;
      text-align: center;
      font-size: 35px;
    }

    .columnHeader {
      background-color: #f1f1f1;
      padding: 3px;
      text-align: center;
      font-size: 20px;
    }

    /* Container for flexboxes */
    .row {
      display: -webkit-flex;
      display: flex;
    }

    /* Create three equal columns that sits next to each other */
    .column {
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      padding: 1vw;

      /* Should be removed. Only for demonstration */
    }

    /* Style the footer */
    .footer {
      background-color: #f1f1f1;
      padding: 10px;
      text-align: center;
    }

    /* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
    @media (max-width: 600px) {
      .row {
        -webkit-flex-direction: column;
        flex-direction: column;
      }
    }



    /* Style the tab */
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
    }

    /* Style the buttons that are used to open the tab content */
    .tab button {
      /*
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      */
      font-family: Arial, Helvetica, sans-serif;
      font-size: 15px;
      background-color: inherit;
      cursor: pointer;
      transition: 0s;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      padding: 1vw;
    }

    /* Change background color of buttons on hover */
    .tab button:hover {
      background-color: #ddd;
    }

    /* Create an active/current tablink class */
    .tab button.active {
      background-color: #ccc;
    }

    /* Style the tab content */
    .tabcontent {
      display: none;
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-top: none;
    }
  </style>

  <!--Not sure if I need this
  <style>
    video {
      max-width: 100%;
      height: auto;
    }
  </style>
  -->

</head>

<body>
  <h1>Boat Connection Interface NEW TEST</h1>
  <div class="row" height>
    <div class="column" style="background-color:#aaa;">
      <div class="columnHeader">
        ROS Status & Controller Input
      </div>
      <p>Rosbridge Connection Status: <span id="rosConnStatus"></span></p>

    </div>
    <div class="column" height="115px" style="background-color:#bbb; min-width: 0; min-height: 0;">
      <div class="columnHeader">Controller Input</div>
      <canvas id="Chart_Controller"></canvas>
      <span id="gamepad_ID"></span>
    </div>
    <div class="column" height="115px" style="background-color:#ccc; min-width: 0; min-height: 0;">
      <div class="columnHeader">Battery Charge</div>
      <canvas id="Chart_Battery"></canvas>
    </div>
  </div>
  <div class="row">
    <div class="column" style="background-color:#eee;">
      <div class="columnHeader">ZED Stream</div>
      <div id="ZED_Raw">
        <h3 onclick="this.parentElement.style.display='none'">ZED Camera Raw Stream (Click this to close the video stream)</h3>
        <img style="max-width: 100%; height: auto; margin: auto;" src="http://10.19.122.102:8080/stream?topic=/zed/zed_node/stereo_raw/image_raw_color">
      </div>
    </div>
  </div>
  <div class="row">
    <div class="column" style="background-color:#eee;">
      <div class="columnHeader">IMU Data</div>
    </div>
  </div>
  <div class="row">
    <div class="column" width="25vw" style="background-color:#aaa; align-items: center; justify-content: center;">
      <canvas id="myCanvas" style="position:relative;top: 0px; left: 0px;  width: 25vw; height: 30vw;"></canvas>
    </div>
    <div class="column" style="background-color:#bbb; -webkit-flex: 3; min-width: 0; min-height: 0">
      <!-- Tab links -->
      <div class="tab">
        <button class="tablinks" onclick="openCity(event, 'Tab_IMU_OrientationDeg')" id="Tab_Default_IMU">Orientation</button>
        <button class="tablinks" onclick="openCity(event, 'Tab_IMU_Accel')">Acceleration</button>
      </div>
      <!-- Tab content -->
      <div id="Tab_IMU_OrientationDeg" class="tabcontent">
        <canvas id="Chart_OrientationDeg" height="115vw"></canvas>
      </div>

      <div id="Tab_IMU_Accel" class="tabcontent">
        <canvas id="Chart_Acceleration" height="115vw"></canvas>
      </div>

    </div>
  </div>
  <div class="row">
    <div class="column" style="background-color:#eee;">
      <div class="columnHeader">GPS Data</div>
    </div>
  </div>
  <div class="row">
    <div class="column" style="background-color:#aaa; align-items: center; justify-content: center;">
      <div class="columnHeader">
        GPS Topic Data
      </div>
      <p>GPS Fix: <span id="GPS_fix"></span></p>
      <p>Fix Quality: <span id="GPS_fixquality"></span></p>
      <p>Latitude: <span id="GPS_latitude"></span> [deg]</p>
      <p>Longitude: <span id="GPS_longitude"></span> [deg]</p>
      <p>Altitude: <span id="GPS_altitude"></span> [cm]</p>
    </div>
    <div class="column" style="background-color:#bbb; -webkit-flex: 2">
      <div class="columnHeader">
        Map
      </div>
      <div id="map"></div>
    </div>
  </div>
  
  </div>

  <script type="text/javascript">
    //GAME PAD OUTPUT


    function move(axVal) {
      var lScale = new ROSLIB.Message({
        data: -axVal[1]
      });
      var rScale = new ROSLIB.Message({
        data: -axVal[4]
      });
      ard_LeftPWM_listener.publish(lScale);
      ard_RightPWM_listener.publish(rScale);

      Chart_Controller.data.datasets[0].data = [{
        x: -2 + axVal[0],
        y: -axVal[1],
        r: 15
      }];
      Chart_Controller.data.datasets[1].data = [{
        x: 2 + axVal[2],
        y: -axVal[3],
        r: 15
      }];
      Chart_Controller.update(0);
    }

    function gamepadHandler(event, connecting) {
      if (connecting) {
        var gp = event.gamepad;
        console.log(gp.id);
        if (gp.id.localeCompare("Xbox One Wired Controller (STANDARD GAMEPAD Vendor: 045e Product: 02d1)") == 0) {
          gpidx = gp.index;
          console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.", gp.index, gp.id, gp.buttons.length, gp.axes.length);
          zeroAxis();
          setInterval(updateControl, gpPollInt);
          document.getElementById("gamepad_ID").innerHTML = gp.id;
        } else {
          console.log("Invalid Gamepad");
          gpidx = -1;
          clearInterval(gpPollInt);
        }
      } else {
        gpidx = -1;
        clearInterval(gpPollInt);
      }
    }

    function updateControl() {
      var gp = navigator.getGamepads()[gpidx];
      if (gp != null && gpidx != -1) {
        if (gp.buttons[zeroAxisButton].pressed == true) {
          zeroAxis();
        }
        for (var i = 0; i < gp.axes.length; i++) {
          //We only care about one gamepad connected, so this will only apply an axis offset
          //to a single gamepad, not multiple
          //document.getElementById("gpax$i".replace("$i", i)).innerHTML = gp.axes[i] - axisOffset[i];
        }
        move(gp.axes);
      } else {
        move([0, 0, 0, 0]);
      }
    }

    function zeroAxis() {
      var gp = navigator.getGamepads()[gpidx];
      for (var i = 0; i < gp.axes.length; i++) {
        axisOffset[i] = gp.axes[i];
      }
      console.log("Axis Zeroed");
    }

    const SERVCTL_StartROS = 1;

    function ServerControl(opt) {
      if (opt == SERVCTL_StartROS) { // Start ROSCore &
        console.log("You pressed the button! %d", opt);
      }
    }

    window.addEventListener("gamepadconnected", function(e) {
      gamepadHandler(e, true);
    }, false);
    window.addEventListener("gamepaddisconnected", function(e) {
      gamepadHandler(e, false);
    }, false);
  </script>



  <script src="src/OrientationAnimation.js"></script>
  <script type='text/javascript'>
    camera.eye = [0.06274989247322083, 25.782859802246094, 99.44140625];
  </script>


  <script>
    document.getElementById("Tab_Default_IMU").click();
    /*
    mapboxgl.accessToken = 'pk.eyJ1IjoiYnlyb25nYXNwYXJkIiwiYSI6ImNrOGtudGIxMzAzdm8zZ28yNDFuMHcwdXQifQ.fY_gpP0xJ77xE-OyyH_wbg';
    map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/outdoors-v11',
      center: [-75.152842, 39.982492], // Set to Temple Engineering location on startup
      zoom: 16
    });

    marker = new mapboxgl.Marker({
      color: `rgb(255, 0, 0)`
    }).setLngLat([-75.152842, 39.982492]).addTo(map);
    */

    var ctx = document.getElementById('Chart_OrientationDeg').getContext('2d');
    var Chart_OrientationDeg = new Chart(ctx, {
      // The type of chart we want to create
      type: 'line',

      // The data for our dataset
      data: {
        labels: ['0'],
        datasets: [{
          label: 'X',
          //backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(255, 0, 0)',
          data: [0]
        }, {
          label: 'Y',
          //backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(0, 255, 0)',
          data: [0]
        }, {
          label: 'Z',
          //backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(0, 0, 255)',
          data: [0]
        }]
      },

      // Configuration options go here
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Orientation [deg]'
            },
          }]
        }
      }
    });

    var ctx = document.getElementById('Chart_Acceleration').getContext('2d');
    var Chart_Acceleration = new Chart(ctx, {
      // The type of chart we want to create
      type: 'line',
      // The data for our dataset
      data: {
        labels: ['0'],
        datasets: [{
          label: 'X',
          //backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(255, 0, 0)',
          data: [0]
        }, {
          label: 'Y',
          //backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(0, 255, 0)',
          data: [0]
        }, {
          label: 'Z',
          //backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(0, 0, 255)',
          data: [0]
        }]
      },
      // Configuration options go here
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Acceleration [m/(s^2)]'
            },
          }]
        }
      }
    });

    var ctx = document.getElementById('Chart_Battery').getContext('2d');
    var Chart_Battery = new Chart(ctx, {
      // The type of chart we want to create
      type: 'horizontalBar',
      // The data for our dataset
      data: {
        labels: ['6 Cell', '4 Cell', '3 Cell (A)', '3 Cell (B)'],
        datasets: [{
          backgroundColor: 'rgb(20, 33, 77)',
          label: 'Cell 1',
          //backgroundColor: 'rgb(255, 99, 132)',
          data: [0]
        }, {
          backgroundColor: 'rgb(24, 96, 147)',
          label: 'Cell 2',
          data: [0]
        }, {
          backgroundColor: 'rgb(28, 160, 214)',
          label: 'Cell 3',
          data: [0]
        }, {
          backgroundColor: 'rgb(31, 193, 224)',
          label: 'Cell 4',
          data: [0]
        }, {
          backgroundColor: 'rgb(33, 205, 205)',
          label: 'Cell 5',
          data: [0]
        }, {
          backgroundColor: 'rgb(36, 223, 182)',
          label: 'Cell 6',
          data: [0]
        }]
      },
      // Configuration options go here
      options: {
        tooltips: {
          mode: 'index',
          intersect: true
        },
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          xAxes: [{
            ticks: {
              beginAtZero: true
            },
            scaleLabel: {
              display: true,
              labelString: 'Voltage [V]'
            },
            stacked: true
          }],
          yAxes: [{
            ticks: {
              beginAtZero: true
            },
            stacked: true
          }]
        }
      }
    });

    var ctx = document.getElementById('Chart_Controller').getContext('2d');
    var Chart_Controller = new Chart(ctx, {
      // The type of chart we want to create
      type: 'bubble',
      // The data for our dataset

      data: {
        datasets: [{
          backgroundColor: 'rgb(255, 0, 0)',
          label: 'Left Joystick',
          //backgroundColor: 'rgb(255, 99, 132)',
          data: [{
            x: -2,
            y: 0,
            r: 15
          }]
        }, {
          backgroundColor: 'rgb(0, 255, 0)',
          label: 'Right Joystick',
          //backgroundColor: 'rgb(255, 99, 132)',
          data: [{
            x: 2,
            y: 0,
            r: 15
          }]
        }]
      },
      // Configuration options go here
      options: {
        tooltips: {
          mode: 'index',
          intersect: true
        },
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          xAxes: [{
            ticks: {
              min: -3.5,
              max: 3.5
            },
          }],
          yAxes: [{
            ticks: {
              min: -1.5,
              max: 1.5
            },
          }]
        }
      }
    });
  </script>


  <script src="src/ros_RoboBoatHandlers.js"></script>

</body>


</body>

</html>
