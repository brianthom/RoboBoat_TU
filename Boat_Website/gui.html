<!DOCTYPE html>
<html>
<html lang = "en">
<head>
  <meta charset="utf-8" />

  <!-- Downloaded from: https://github.com/RobotWebTools/roslibjs/blob/develop/build/roslib.js -->
  <script type="text/javascript" src="roslib.js"></script>
  <script type="text/javascript" type="text/javascript">

    // Use the IP Address of the Raspberry Pi or the device hosting the webserver
    // Port 9090 is the port that rosbridge server uses to interface over the network
    var ros = new ROSLIB.Ros({url:'ws://10.19.122.101:9090'});
    ros.on('connection', function () {document.getElementById("rosConnStatus").innerHTML = "Connected";});
    ros.on('error', function (error) {document.getElementById("rosConnStatus").innerHTML = "Error";});
    ros.on('close', function () {document.getElementById("rosConnStatus").innerHTML = "Closed";});


    ard_LeftPWM_listener = new ROSLIB.Topic({
      ros: ros,
      name: '/ard_LeftPWM',
      messageType: 'std_msgs/Float32'
    });

    ard_RightPWM_listener = new ROSLIB.Topic({
      ros: ros,
      name: '/ard_RightPWM',
      messageType: 'std_msgs/Float32'
    });

  function move(axVal) {
    var lScale = new ROSLIB.Message({data: -axVal[1]});
    var rScale = new ROSLIB.Message({data: -axVal[4]});
    ard_LeftPWM_listener.publish(lScale);
    ard_RightPWM_listener.publish(rScale)
  }

//GAME PAD OUTPUT
	var axisOffset = [0,0,0,0];
	var gpPollInt = 100;
	var gpidx;

	function gamepadHandler(event, connecting) {
	  if (connecting) {
  		var gamepad = event.gamepad;
  		gpidx = gamepad.index;
  		console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.", gamepad.index, gamepad.id, gamepad.buttons.length, gamepad.axes.length);
  		zeroAxis();
  		setInterval(updateControl, gpPollInt);
      document.getElementById("gamepad_ID").innerHTML = e.gamepad.id;
	  }
    else {
  		gamepad = null;
  		clearInterval(gpPollInt);
	  }
	}

	function updateControl()
	{
		gp = navigator.getGamepads();
		for(var i = 0; i < gp[gpidx].axes.length; i++)
		{
			//We only care about one gamepad connected, so this will only apply an axis offset
			//to a single gamepad, not multiple
			document.getElementById("gpax$i".replace("$i",i)).innerHTML = gp[gpidx].axes[i] - axisOffset[i];
		}
		move(gp[gpidx].axes);
	}

	function zeroAxis()
	{
		gp = navigator.getGamepads();
		for(var i = 0; i < gp[gpidx].axes.length; i++)
		{
			axisOffset[i] = gp[gpidx].axes[i];
		}
	}

	window.addEventListener("gamepadconnected", function(e) { gamepadHandler(e, true); }, false);
	window.addEventListener("gamepaddisconnected", function(e) { gamepadHandler(e, false); }, false);

  </script>

</head>

<body>
  <h1>Boat Connection Interface NEW TEST</h1>
  <p>Rosbridge Connection Status: <span id="rosConnStatus"></span></p>

  <p>Axis 0 (LStick-Hori): <span id="gpax0"></span></p>
  <p>Axis 1 (LStick-Vert): <span id="gpax1"></span></p>
  <p>Axis 2 (LTrigger)   : <span id="gpax2"></span></p>
  <p>Axis 3 (RStick-Hori): <span id="gpax3"></span></p>
  <p>Axis 4 (RStick-Vert): <span id="gpax4"></span></p>
  <p>Axis 5 (RTrigger)   : <span id="gpax5"></span></p>
  <p>Gamepad ID          : <span id="gamepad_ID"></span></p>

</body>

</html>
