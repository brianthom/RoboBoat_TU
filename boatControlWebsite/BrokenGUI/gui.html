<!DOCTYPE html>
<html>
<html lang = "en">
<head>
  <meta charset="utf-8" />

  <!-- Downloaded from: https://github.com/RobotWebTools/roslibjs/blob/develop/build/roslib.js -->
  <script type="text/javascript" src="roslib.js"></script>
  <script type="text/javascript" type="text/javascript">

    var ros = new ROSLIB.Ros({url:'ws://192.168.8.111:9090'});
    ros.on('connection', function () {document.getElementById("rosConnStatus").innerHTML = "Connected";});
    ros.on('error', function (error) {document.getElementById("rosConnStatus").innerHTML = "Error";});
    ros.on('close', function () {document.getElementById("rosConnStatus").innerHTML = "Closed";});

    cmd_vel_listener = new ROSLIB.Topic({
      ros: ros,
      name: '/cmd_vel',
      messageType: 'geometry_msgs/Twist'
    });
   
    function move(axVal) {
      var twist = new ROSLIB.Message({
        linear: {
          x: axVal[0],
          y: axVal[1],
          z: 0
        },
        angular: {
          x: axVal[2],
          y: axVal[3],
          z: 0
        }
      });
      cmd_vel_listener.publish(twist);
    }

//GAME PAD OUTPUT
	var axisOffset = [0,0,0,0];
	var gpPollInt = 100;
	var gpidx;

	function gamepadHandler(event, connecting) {
	  if (connecting) {
		var gamepad = event.gamepad;
		gpidx = gamepad.index;
		console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.", gamepad.index, gamepad.id, gamepad.buttons.length, gamepad.axes.length);
		zeroAxis();		
		setInterval(updateControl, gpPollInt);
	  } else {
		gamepad = null;
		clearInterval(gpPollInt);
	  }
	}

	function updateControl()
	{
		gp = navigator.getGamepads();
		for(var i = 0; i < gp[0].axes.length; i++)
		{
			//We only care about one gamepad connected, so this will only apply an axis offset
			//to a single gamepad, not multiple
			document.getElementById("gpax$i".replace("$i",i)).innerHTML = gp[0].axes[i] - axisOffset[i];	
		}
		move(gp[0].axes);
	}

	function zeroAxis()
	{
		gp = navigator.getGamepads();
		for(var i = 0; i < gp[0].axes.length; i++)
		{
			axisOffset[i] = gp[0].axes[i];
		}
	}

	window.addEventListener("gamepadconnected", function(e) { gamepadHandler(e, true); }, false);
	window.addEventListener("gamepaddisconnected", function(e) { gamepadHandler(e, false); }, false);

  </script>
 
</head>

<body>
  <h1>Boat Connection Interface</h1>
  <p>Rosbridge Connection Status: <span id="rosConnStatus"></span></p>
  <p>Axis 0 (LH): <span id="gpax0"></span></p>
  <p>Axis 1 (LV): <span id="gpax1"></span></p>
  <p>Axis 2 (RH): <span id="gpax2"></span></p>
  <p>Axis 3 (LH): <span id="gpax3"></span></p>
</body>

</html>


